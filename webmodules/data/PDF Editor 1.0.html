<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Single-Page PDF Editor</title>
<style>
body {margin:0;font-family:sans-serif;background:#0f1220;color:#e7eaf6;}
.toolbar {display:flex;gap:0.5rem;padding:0.5rem;background:#171a2b;position:sticky;top:0;}
.toolbar button, .toolbar label {background:#262c44;color:#e7eaf6;border:none;padding:0.5rem 0.7rem;border-radius:8px;cursor:pointer;}
.workspace {position:relative;padding:1rem;}
canvas {display:block;background:#fff;}
</style>
</head>
<body>

<div class="toolbar">
  <label for="fileInput">📄 Upload PDF</label>
  <input type="file" id="fileInput" accept="application/pdf" style="display:none;">
  <button id="toolSelect">🖱️ Select</button>
  <button id="toolPen">✏️ Pen</button>
  <button id="toolRect">▭ Rect</button>
  <button id="toolText">🔤 Text</button>
  <button id="toolImage">🖼️ Image</button>
  <input type="file" id="imageInput" accept="image/*" style="display:none;">
  <button id="download" disabled>⬇️ Download</button>
</div>

<div class="workspace">
  <canvas id="pdfCanvas"></canvas>
  <canvas id="overlay" style="position:absolute;top:0;left:0;"></canvas>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
const pdfCanvas = document.getElementById('pdfCanvas');
const overlayCanvas = document.getElementById('overlay');
const fileInput = document.getElementById('fileInput');
const downloadBtn = document.getElementById('download');
const toolSelectBtn = document.getElementById('toolSelect');
const toolPenBtn = document.getElementById('toolPen');
const toolRectBtn = document.getElementById('toolRect');
const toolTextBtn = document.getElementById('toolText');
const toolImageBtn = document.getElementById('toolImage');
const imageInput = document.getElementById('imageInput');

let pdfDoc=null,pdfBytes=null,fabricCanvas=null,scale=1.25;

pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function renderPDF(bytes){
  pdfBytes = bytes;
  pdfDoc = await pdfjsLib.getDocument({data: bytes}).promise;
  const page = await pdfDoc.getPage(1);
  const viewport = page.getViewport({scale});
  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;
  overlayCanvas.width = viewport.width;
  overlayCanvas.height = viewport.height;
  await page.render({canvasContext: pdfCanvas.getContext('2d'), viewport}).promise;

  if(!fabricCanvas){
    fabricCanvas = new fabric.Canvas('overlay');
    fabricCanvas.isDrawingMode=false;
  } else {
    fabricCanvas.clear();
    fabricCanvas.setWidth(viewport.width);
    fabricCanvas.setHeight(viewport.height);
  }

  downloadBtn.disabled=false;
}

fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(){
      renderPDF(new Uint8Array(this.result));
    };
    reader.readAsArrayBuffer(file);
  }
});

// Tool buttons
toolSelectBtn.addEventListener('click', ()=>{fabricCanvas.isDrawingMode=false;});
toolPenBtn.addEventListener('click', ()=>{fabricCanvas.isDrawingMode=true;});
toolRectBtn.addEventListener('click', ()=>{
  const rect = new fabric.Rect({width:100,height:60,left:50,top:50,fill:'transparent',stroke:'red',strokeWidth:2});
  fabricCanvas.add(rect);
});
toolTextBtn.addEventListener('click', ()=>{
  const text = new fabric.IText('Text',{left:50,top:50,fill:'black',fontSize:20});
  fabricCanvas.add(text);
});
toolImageBtn.addEventListener('click', ()=>{imageInput.click();});
imageInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(ev){
      fabric.Image.fromURL(ev.target.result,img=>{img.set({left:50,top:50,scaleX:0.5,scaleY:0.5});fabricCanvas.add(img);});
    }
    reader.readAsDataURL(file);
  }
});

// Download edited PDF
downloadBtn.addEventListener('click', async ()=>{
  const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);
  const page = pdfLibDoc.getPage(0);
  const png = overlayCanvas.toDataURL('image/png');
  const imgBytes = await fetch(png).then(r=>r.arrayBuffer());
  const img = await pdfLibDoc.embedPng(imgBytes);
  page.drawImage(img,{x:0,y:0,width:overlayCanvas.width,height:overlayCanvas.height});
  const pdfBytesOut = await pdfLibDoc.save();
  const blob = new Blob([pdfBytesOut],{type:'application/pdf'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='edited.pdf'; a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
